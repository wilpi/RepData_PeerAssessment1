# Reproducible Research: Peer Assessment 1


## Loading and preprocessing the data

```{r}
packages <- c("data.table", "ggplot2", "xtable", "VIM")
sapply(packages, require, character.only=TRUE, quietly=TRUE)
```

> Show any code that is needed to
>
> 1. Load the data (i.e. `read.csv()`)
>
> 2. Process/transform the data (if necessary) into a format suitable for your analysis

Unzip the data file.

```{r}
executable <- file.path("C:", "Program Files (x86)", "7-Zip", "7z.exe")
parameters <- "x"
f <- file.path(getwd(), "activity.zip")
switch <- "-aoa"
cmd <- paste(paste0("\"", executable, "\""), parameters, paste0("\"", f, "\""), switch)
cmd
system(cmd)
```

Read the CSV file.
Convert the data frame to a data table using the [`data.table`]


```{r}
dt <- read.csv(file.path(getwd(), "activity.csv"))
dt <- data.table(dt)
```
 
Verify that the number of rows in the dataset is the expected value of 17,568.

```{r}
check <- nrow(dt) == 17568
if (check == FALSE) stop("The number of rows in the dataset is not 17,568.")
```

Convert the `date` variable to a date class.
And look at the structure of the dataset.

```{r}
dt <- dt[, date := as.Date(date)]
setkey(dt, date, interval)
str(dt)
dt
```



## What is mean total number of steps taken per day?

> For this part of the assignment, you can ignore the missing values in
> the dataset.
>
> 1. Make a histogram of the total number of steps taken each day
>
> 2. Calculate and report the **mean** and **median** total number of steps taken per day

Aggregate the number of steps taken each day.
Days with missing values (`NA`) will have `NA` when aggregated.

```{r}
dtDaily <- dt[, list(sumSteps = sum(steps)), date]
head(dtDaily)
```

Plot a histogram of the total number of steps taken each day.

```{r histogramStepsTakenEachDay}
ggplot(dtDaily, aes(x=sumSteps)) +
geom_histogram(alpha=1/2, binwidth=1000)
```

Calculate the mean and median total number of steps taken per day **before imputing**.

```{r, results='asis'}
tab <- dtDaily[, list(n = .N, nValid = sum(!is.na(sumSteps)), mean = mean(sumSteps, na.rm=TRUE), median = median(sumSteps, na.rm=TRUE))]
print(xtable(tab), type="html", include.rownames=FALSE)
```

Copy the data table `dtDaily` before imputation to be used later.

```{r}
dtDaily <- dtDaily[, status := "Before imputation"]
dtDailyBeforeImputation <- dtDaily
```


## What is the average daily activity pattern?


> 1. Make a time series plot (i.e. `type = "l"`) of the 5-minute interval (x-axis) and the average number of steps taken, averaged across all days (y-axis)
>
> 2. Which 5-minute interval, on average across all the days in the dataset, contains the maximum number of steps?

Aggregate the average number of steps taken by 5-minute interval.

```{r}
dtIntervals <- dt[, list(meanSteps = mean(steps, na.rm=TRUE)), interval]
```

Plot a time series of the 5-minute interval and the average number of steps taken across all days.

```{r timeseriesStepsTakenEachInterval}
ggplot(dtIntervals, aes(x=interval, y=meanSteps)) +
geom_line()
```


## Imputing missing values

Calculate the total number of missing values.

```{r, results='asis'}
dt <- dt[, isStepsMissing := is.na(steps)]
tab <- dt[, .N, isStepsMissing]
print(xtable(tab), type="html", include.rownames=FALSE)
```

Use k-Nearest Neighbour Imputation.
I couldn't get Iterative robust model-based imputation (IRMI) to work; try again later.

```{r}
dt <- kNN(dt)
# dt <- irmi(dt)
```

Verify that there are no missing values for `steps` after imputation.

```{r, results='asis'}
tab <- dt[, .N, list(isMissing = is.na(steps))]
print(xtable(tab), type="html", include.rownames=FALSE)
```

```{r}
dtMissingness <- dt[, list(countMissing = sum(isStepsMissing), countRecords = .N, propMissing = sum(isStepsMissing / .N)), date]
dtMissingness[countMissing > 0]
```



## Are there differences in activity patterns between weekdays and weekends?

```{r}
levels <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")
newLevels <- c("Weekend", rep("Weekday", 5), "Weekend")
dt <- dt[, dayOfWeek := factor(weekdays(date), levels=levels)]
dt <- dt[, dayType := factor(newLevels[dayOfWeek])]
dt[, .N, list(dayType, dayOfWeek)]
message(sprintf("Is dayOfWeek a factor? %s. Is dayType a factor? %s", is.factor(dt$dayOfWeek), is.factor(dt$dayType)))
```

Aggregate the average number of steps taken by 5-minute interval.
Use the imputed values in the `steps` variable.

```{r}
dtIntervals <- dt[, list(meanSteps = mean(steps, na.rm=TRUE)), list(dayType, interval)]
```

Plot two time series (one for weekdays and the other for weekends) of the 5-minute intervals and average number of steps taken (imputed values).

```{r timeseriesStepsTakenEachIntervalByDayTypePanel}
ggplot(dtIntervals, aes(x=interval, y=meanSteps, color=dayType)) +
geom_line() +
facet_wrap(~ dayType, nrow=2) +
theme(legend.position="none")
```

It's a bit hard to discern any differences.
So overlay the time series on a single plot instead of using a panel plot.

```{r timeseriesStepsTakenEachIntervalByDayType}
ggplot(dtIntervals, aes(x=interval, y=meanSteps, color=dayType)) +
geom_line() +
theme(legend.position="bottom")
```


